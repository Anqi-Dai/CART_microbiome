---
title: "rethinking antibiotics"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```
 
```{r}
library(rethinking)
library(tidyverse)  
library(haven) #for reading sav data
library(sjstats) #for calculating intra-class correlation (ICC)
library(effects) #for plotting parameter effects
library(jtools) #for transformaing model summaries
library(ROCR)
```

# CR/Toxicity ~ abx + center

## Toxicity

```{r}
# none of the patients from Penn received the 3 anaerobe-targeting antibiotics in the 4 weeks prior to CAR T cell infusion
# msk table
m <- readxl::read_excel('/Volumes/castoricenter/CAR-Tcell_and_Microbiota/MSK/antibiotics/sean_table/abx_table_msk_sean.xlsx') %>% 
  select(pt_id, anaerobe_targeting)

meta <- read_csv('../data/amplicon/stool/combined_2_meta_expanded.csv') %>% 
  left_join(m) %>% 
  mutate(anaerobe_targeting = if_else(is.na(anaerobe_targeting), 'no', anaerobe_targeting)) %>% 
  mutate(anaerobe = if_else(anaerobe_targeting == 'no', 0, 1))

set.seed(123)
dat_list <- list(
    tox = meta$tox,
    cr100 = meta$cr100,
    location = meta$loca,
    anaerobe = meta$anaerobe
    )

meta %>% 
  count(center, anaerobe_targeting) 
```

```{r}   
atox <- ulam(
    alist(
        tox ~ dbinom( 1 , p ) ,
        logit(p) <- b*anaerobe + a[location] ,
        b ~ dnorm( 0 , 1), 
        a[location] ~ dnorm( 0 , 0.5 )
    ) , data=dat_list , chains=4 , log_lik=TRUE , cores = 8)
precis(atox, depth = 2)
plot(precis(atox, depth = 2) ) 
# seems anaerobe abx is positively linked with toxicity 
```


## CR day 100 

```{r}
acr <- ulam(  
    alist(
        cr100 ~ dbinom( 1 , p ) ,
        logit(p) <- b*anaerobe + a[location] ,
        b ~ dnorm( 0 , 1), 
        a[location] ~ dnorm( 0 , 0.5 )
    ) , data=dat_list , chains=4 , log_lik=TRUE , cores = 8)
precis(acr, depth = 2)
plot(precis(acr, depth = 2) ) 
# nothing interesting 
```

