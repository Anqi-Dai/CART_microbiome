---
title: "I mean really clean the pheno and get to know the hell of the samples"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
library(tidyverse)
library(readxl)
library(RVenn)
```
 
## Valid patient samples

```{r}
# the newest pheno table from M
# this sheet have nice sampleids for the samples, and also this is the table has all of the info
phe_M <- read_excel('/Volumes/castoricenter/CAR-Tcell_and_Microbiota/CTC Event Table 10232019 wo Censor .xlsx',
                    sheet = 5)
```

```{r}
# selecting the columns relavant to this study
phe_M_clean <- phe_M %>% 
   rename_all(funs(str_replace_all(., ' \\(.+$','') %>% 
    str_replace_all(., ' ','_') %>% 
    str_replace(., ':','_'))) %>% 
  # select the columns that may be relavant
  select(Sampleid = Baseline_Sample_ID, 
         Censor_reason,
         CR, 
         ORR, 
         Toxicity, 
         Disease_Status_CAR = Key__Patient_Disease_Status_at_CAR, 
         Disease_Class, 
         CAR_Group) %>% 
  filter(is.na(Censor_reason)) 

nrow(phe_M_clean)

head(phe_M_clean)


# output this pheno table cuz its gonna be used downstream
# this is all of the baseline samples that has 16s.
phe_M_clean %>% 
  write_csv('../data/cleaned_pheno/current_pheno.csv')
```


## Valid shotgun data


```{r}
# loading the table from John to see how many samples we actually have shotgun data
have_sg <- read_csv('../data/baselinesforAngel10032019.csv') %>% 
  filter(shotgun_YN == 'yes') %>% 
  # removig 1943A cuz its low quality
  filter(sample_id != '1943A') %>% 
  ### FUCK THIS TABLE OF ../data/baselinesforAngel10032019.csv IS WRONG IN 161, it didnâ€™t pass QC because not enough DNA material was present. SO WE DON'T HAVE THE SHOTGUN DATA.
  filter(!sample_id %in% c('161'))

nrow(have_sg)
  


```

## Overlap: the real valid shotgun samples

```{r}
# visualize the difference 
two <- Venn(list(
  have_file = have_sg$sample_id,
  useable = phe_M_clean$Sampleid
))  
  
ggvenn(two)      


# so the final shotgun samples number will be 33
length(intersect(have_sg$sample_id, phe_M_clean$Sampleid))

final_sample_id <- intersect(have_sg$sample_id, phe_M_clean$Sampleid)

# so the final removed 2 samples are:
setdiff(pheno_col$Sampleid, final_sample_id) 
```

```{r}
# the final pheno table which has 33 rows
final_pheno <- phe_M_clean %>% 
  filter(Sampleid %in% have_sg$sample_id)

final_pheno %>% 
  write_csv('../data/cleaned_pheno/final_pheno.csv')
```


```{r}
# write out the overlap sampleid cuz that's gonna be the sample_names in use on the cluster for normalization
intersect(have_sg$sample_id, phe_M_clean$Sampleid) %>%  
  write.table('../data/input_for_cluster_sampleid/valid_sample_names.txt', col.names = F, row.names = F, quote = F)
```

