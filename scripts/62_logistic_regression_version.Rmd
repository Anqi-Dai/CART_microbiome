---
title: "logistic regression"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F)
```

```{r}
library(magrittr)
library(ggeffects)
library(tidyverse)
library(lme4)
library(cowplot)
library(grid)
library(ggpubr)
```

```{r}
meta <- read_csv('../data/amplicon/stool/combined_2_meta.csv') %>% 
  mutate(center = factor(center),
         toxicity = factor(toxicity, levels = c('no','yes')),
         cr_d100 = factor(cr_d100, levels = c('no','yes')))

dat <- meta %>% 
  select(toxicity,cr_d100, simpson_reciprocal, center)

dat %>% 
  head
```

# Alpha diversity as predictor

## Toxicity ~ alpha diversity + center

**The ggeffects package computes estimated marginal means (predicted values) for the response, at the margin of specific values or levels from certain model terms, i.e. it generates predictions by a model by holding the non-focal variables constant and varying the focal variable(s). ggpredict() uses predict() for generating predictions**

```{r}
m_tox <- glm(
  toxicity ~ simpson_reciprocal + center, 
  data = dat, 
  family = binomial(link = "logit")
)
summary(m_tox)

ggpredict(m_tox,se=TRUE,interactive=TRUE,digits=3, c('simpson_reciprocal')) %>% plot()
```

## CR ~ alpha diversity + center

```{r}
m_CR <- glm(
  cr_d100 ~ simpson_reciprocal + center, 
  data = dat, 
  family = binomial(link = "logit")
)
summary(m_CR)

ggpredict(m_CR,se=TRUE,interactive=TRUE,digits=3, c('simpson_reciprocal')) %>% plot()
```

# 5 genera as predictor

## Toxicity ~ Akkermansia + Bacteroides + Enterococcus + Faecalibacterium + Ruminococcus + center

The genera's relative abundance is log10 transformed. 

```{r}
genera <- read_csv('../data/amplicon/stool/combined_5_genera.csv')

# the CLR transformed genera abundance 
clr <- read_csv('../data/amplicon/stool/counts_genus_combined_CLR.csv')  %>% 
  spread(key = 'genus', value = 'clr')

gmeta <- meta  %>% 
  inner_join(clr) %>% 
  select(toxicity,cr_d100, Akkermansia,Bacteroides, Enterococcus, Faecalibacterium, Ruminococcus , center)

gmeta %>% 
  head
```

```{r}
g_tox <- glm(
  toxicity ~ Akkermansia + Bacteroides + Enterococcus + Faecalibacterium + Ruminococcus + center, 
  data = gmeta, 
  family = binomial(link = "logit")
)
summary(g_tox)

gb <- ggpredict(g_tox,se=TRUE,interactive=TRUE,digits=3, c('Bacteroides')) %>% plot()
gr <- ggpredict(g_tox,se=TRUE,interactive=TRUE,digits=3, c('Ruminococcus')) %>% plot()
ge <- ggpredict(g_tox,se=TRUE,interactive=TRUE,digits=3, c('Enterococcus')) %>% plot()
ga <- ggpredict(g_tox,se=TRUE,interactive=TRUE,digits=3, c('Akkermansia')) %>% plot()
gf <- ggpredict(g_tox,se=TRUE,interactive=TRUE,digits=3, c('Faecalibacterium')) %>% plot()

gtox <- ggarrange(gb, gr, ge, ga, gf,
    ncol = 1
    #o = 'hv',
    #labels = 'AUTO',
    #axis = 'bltr'
    ) +
    ggsave(str_glue('../figs/amplicon/gtox_CLR_5.pdf'), width = 3, height = 8, dpi = 300)
```

## CR ~ Akkermansia + Bacteroides + Enterococcus + Faecalibacterium + Ruminococcus + center

```{r}
g_CR <- glm(
  cr_d100 ~ Akkermansia + Bacteroides + Enterococcus + Faecalibacterium + Ruminococcus + center, 
  data = gmeta, 
  family = binomial(link = "logit")
)
summary(g_CR)

gb <- ggpredict(g_CR,se=TRUE,interactive=TRUE,digits=3, c('Bacteroides')) %>% plot()
gr <- ggpredict(g_CR,se=TRUE,interactive=TRUE,digits=3, c('Ruminococcus')) %>% plot()
ge <- ggpredict(g_CR,se=TRUE,interactive=TRUE,digits=3, c('Enterococcus')) %>% plot()
ga <- ggpredict(g_CR,se=TRUE,interactive=TRUE,digits=3, c('Akkermansia')) %>% plot()
gf <- ggpredict(g_CR,se=TRUE,interactive=TRUE,digits=3, c('Faecalibacterium')) %>% plot()


gCR <- ggarrange(gb, gr, ge, ga, gf,
    ncol = 1
    #o = 'hv',
    #labels = 'AUTO',
    #axis = 'bltr'
    ) +
    ggsave(str_glue('../figs/amplicon/gcr_CLR_5.pdf'), width = 3, height = 8, dpi = 300)
```

