---
title: "rethinking and the 5 genera"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

```{r}
library(rethinking)
library(tidyverse)  
library(ggpubr)
```

# CR/Toxicity ~ Akkermansia + Bacteroides + Enterococcus + Faecalibacterium + Ruminococcus + center

## Toxicity

```{r}
genera <- read_csv('../data/amplicon/stool/combined_5_genera.csv')

# do not standardize the log transformed relative abundance 
meta <- read_csv('../data/amplicon/stool/combined_2_meta_expanded.csv')  %>% 
  full_join(genera)

# wanna see the range of the 5 genera log 10 relab
meta %>% select(Akkermansia:Ruminococcus) %>% 
  summary
```


```{r}
set.seed(123)   
dat_list <- list(
    tox = meta$tox,
    cr100 = meta$cr100,
    location = meta$loca,
    Akkermansia = meta$Akkermansia,
    Bacteroides = meta$Bacteroides,
    Enterococcus = meta$Enterococcus,
    Faecalibacterium = meta$Faecalibacterium,
    Ruminococcus = meta$Ruminococcus
    ) 
```

```{r}
gtox <- ulam(
    alist(
        tox ~ dbinom( 1 , p ) ,
        logit(p) <- ba*Akkermansia + bb*Bacteroides + be*Enterococcus + bf*Faecalibacterium + br*Ruminococcus + a[location] ,
        ba ~ dnorm( 0 , 1),
        bb ~ dnorm( 0 , 1),
        be ~ dnorm( 0 , 1),
        bf ~ dnorm( 0 , 1),
        br ~ dnorm( 0 , 1),
        a[location] ~ dnorm( 0 , 0.5 )
    ) , data=dat_list , chains=4 , log_lik=TRUE , cores = 8)
plot(precis(gtox, depth = 2, prob = 0.95) )  
# indicative of the Bacteroides link with toxicity  
```

### posterior check 

```{r}
post <- extract.samples(gtox) 
# using the patient with highest and lowest Bacteroides data to plug in
# find the patients
bl <- meta %>% 
  arrange(Bacteroides) %>% 
  slice(1) %>% 
  select(Akkermansia:Ruminococcus)

bh <- meta %>% 
  arrange(-Bacteroides) %>% 
  slice(1) %>% 
  select(Akkermansia:Ruminococcus)
```

```{r}
pl <- inv_logit( post$ba * (-1.612806	) + post$bb * (-5.69897		) + post$be * (-5.69897	) +  post$bf * (-5.69897		) + post$br * (-0.5244935) + post$a[, 1] ) 

ph <- inv_logit( post$ba * (-2.286752	) + post$bb * (-0.4575058) + post$be * (-1.745601	) +  post$bf * (-5.69897) + post$br * (-4.050354) + post$a[, 1] )


bind_rows(
  tibble(
    value = pl,
    grp = 'low'
  ),
  tibble( 
    value = ph,
    grp = 'high'
  )
) %>% 
  gghistogram(x = 'value',bins = 30, fill = 'grp', palette = 'nejm', color = 'white',title = 'MSK')
  
```



## CR

```{r}
gcr <- ulam(
    alist(
        cr100 ~ dbinom( 1 , p ) ,
        logit(p) <- ba*Akkermansia + bb*Bacteroides + be*Enterococcus + bf*Faecalibacterium + br*Ruminococcus + a[location] ,
        ba ~ dnorm( 0 , 1),
        bb ~ dnorm( 0 , 1),
        be ~ dnorm( 0 , 1),
        bf ~ dnorm( 0 , 1),
        br ~ dnorm( 0 , 1),
        a[location] ~ dnorm( 0 , 0.5 )
    ) , data=dat_list , chains=4 , log_lik=TRUE , cores = 8)

plot(precis(gcr, depth = 2, prob = 0.95) ) 
# I think the Ruminococcus still holds for the CR
```


### posterior check 


```{r}
post <- extract.samples(gcr) 
# using the patient with highest and lowest Ruminococcus data to plug in
# find the patients
rl <- meta %>% 
  arrange(Ruminococcus) %>% 
  slice(1) %>% 
  select(Akkermansia:Ruminococcus)

rh <- meta %>% 
  arrange(-Ruminococcus) %>% 
  slice(1) %>% 
  select(Akkermansia:Ruminococcus)

pl <- inv_logit( post$ba * (-3.517128) + post$bb * (-2.447201	) + post$be * (-2.504205	) +  post$bf * (-5.69897	) + post$br * (-5.69897) + post$a[, 1] ) 

ph <- inv_logit( post$ba * (-1.845325	) + post$bb * (-3.052386) + post$be * (-5.69897) +  post$bf * (-5.69897) + post$br * (-0.373353) + post$a[, 1] )


bind_rows(
  tibble(
    value = pl,
    grp = 'low'
  ),
  tibble( 
    value = ph,
    grp = 'high'
  )
) %>% 
  gghistogram(x = 'value',bins = 30, fill = 'grp', palette = 'nejm', color = 'white',title = 'MSK')
   
```

