---
title: "rethinking and the 5 genera"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

```{r}
library(rethinking)
library(tidyverse)  
library(ggpubr)
```

# CR/Toxicity ~ Akkermansia + Bacteroides + Enterococcus + Faecalibacterium + Ruminococcus + center

## Toxicity

```{r}
genera <- read_csv('../data/amplicon/stool/combined_5_genera.csv')

# do not standardize the log transformed relative abundance 
meta <- read_csv('../data/amplicon/stool/combined_2_meta_expanded.csv')  %>% 
  full_join(genera)

# wanna see the range of the 5 genera log 10 relab
meta %>% select(Akkermansia:Ruminococcus) %>% 
  summary
```


```{r}
set.seed(123)   
dat_list <- list(
    tox = meta$tox,
    cr100 = meta$cr100,
    location = meta$loca,
    Akkermansia = meta$Akkermansia,
    Bacteroides = meta$Bacteroides,
    Enterococcus = meta$Enterococcus,
    Faecalibacterium = meta$Faecalibacterium,
    Ruminococcus = meta$Ruminococcus
    ) 
```

```{r}
gtox <- ulam(
    alist(
        tox ~ dbinom( 1 , p ) ,
        logit(p) <- ba*Akkermansia + bb*Bacteroides + be*Enterococcus + bf*Faecalibacterium + br*Ruminococcus + a[location] ,
        ba ~ dnorm( 0 , 1),
        bb ~ dnorm( 0 , 1),
        be ~ dnorm( 0 , 1),
        bf ~ dnorm( 0 , 1),
        br ~ dnorm( 0 , 1),
        a[location] ~ dnorm( 0 , 0.5 )
    ) , data=dat_list , chains=4 , log_lik=TRUE , cores = 8)
plot(precis(gtox, depth = 2, prob = 0.95) )  
# indicative of the Bacteroides link with toxicity  
```

### posterior check 

```{r}
bac_value <- log10(c(0.05, 0.35))
post <- extract.samples(gtox) 
# if all the others are the same (10%) and only Bacteroides relative abundance could be 0 or  0.35
post_tox <- list(m = 1, p = 2) %>% 
  map(function(center_){
    cols = seq(1, length(bac_value)) %>% 
      set_names(seq(1, length(bac_value))) %>% 
      map(function(idx){
         inv_logit( post$ba * (-1) + post$bb * bac_value[idx] + post$be * (-1) +  post$bf * (-1) + post$br * (-1) + post$a[, center_] ) 
      }) 
    
    diff = abs( cols[[1]] -cols[[2]] )
    ret = quantile(diff , probs = c(0.025, 0.5, 0.975))
    return(cols)
  }) 

c('m','p') %>% 
  map(function(x){ tibble(
           post_low = post_tox %>% pluck(x) %>% pluck(1),
           post_high = post_tox %>% pluck(x) %>% pluck(2)
          )  %>% gather() %>% 
      gghistogram(x = 'value',bins = 30, fill = 'key', palette = 'nejm', color = 'white',title = str_glue('{x}')) +
      scale_x_continuous(breaks = seq(0, 1, 0.1)) +
      facet_grid(key ~ .)}) 
```


## CR

```{r}
gcr <- ulam(
    alist(
        cr100 ~ dbinom( 1 , p ) ,
        logit(p) <- ba*Akkermansia + bb*Bacteroides + be*Enterococcus + bf*Faecalibacterium + br*Ruminococcus + a[location] ,
        ba ~ dnorm( 0 , 1),
        bb ~ dnorm( 0 , 1),
        be ~ dnorm( 0 , 1),
        bf ~ dnorm( 0 , 1),
        br ~ dnorm( 0 , 1),
        a[location] ~ dnorm( 0 , 0.5 )
    ) , data=dat_list , chains=4 , log_lik=TRUE , cores = 8)

plot(precis(gcr, depth = 2, prob = 0.95) ) 
# I think the Ruminococcus still holds for the CR
```


### posterior check 

```{r}
rum_value <- log10(c(0.05, 0.5))
post <- extract.samples(gcr) 
# if all the others are the same (10%) and only Ruminococcus relative abundance could be 0 or  0.5
post_cr <- list(m = 1, p = 2) %>% 
  map(function(center_){
    cols = seq(1, length(rum_value)) %>% 
      set_names(seq(1, length(rum_value))) %>% 
      map(function(idx){
         inv_logit( post$ba * (-1) + post$bb * rum_value[idx] + post$be * (-1) +  post$bf * (-1) + post$br * (-1) + post$a[, center_] ) 
      }) 
    
    diff = abs( cols[[1]] -cols[[2]] )
    ret = quantile(diff , probs = c(0.025, 0.5, 0.975))
    return(cols)
  })  

c('m','p') %>% 
  map(function(x){ tibble(
           post_low = post_cr %>% pluck(x) %>% pluck(1),
           post_high = post_cr %>% pluck(x) %>% pluck(2)
          )  %>% gather() %>% 
      gghistogram(x = 'value',bins = 30, fill = 'key', palette = 'nejm', color = 'white',title = str_glue('{x}')) +
      scale_x_continuous(breaks = seq(0, 1, 0.1)) +
      facet_grid(key ~ .)}) 
```

