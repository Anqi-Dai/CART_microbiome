---
title: "combine all centers pheno"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

```{r}
# all centers pheno file 
# to get the baseline sampleid 
I <- read_csv('../data/shotgun_pheno/italy_all_earlier.csv') %>% 
  filter(timepoint < 0) %>% 
  ungroup() %>% 
  select(fid)

I2 <- read_csv('../data/shotgun_pheno/italy_all_later.csv') %>% 
  select(fid)

P <- read_csv('../data/shotgun_pheno/upenn_all_earlier.csv') %>% select(fid)

P2 <- read_csv('../data/shotgun_pheno/upenn_all_later.csv') %>% 
  select(fid)

M <- read_csv('../data/shotgun_pheno/msk_all_pheno.csv') %>% select(fid)

all_baseline <- bind_rows(I,I2, M, P, P2)

all_baseline %>% 
  write_csv('../data/shotgun_input/samples_cart_all_msk_patial_italy_upenn.csv', col_names = F)
```

## the pheno label for the samples

```{r}
I2 <- read_csv('../data/shotgun_pheno/italy_all_later.csv')

P <- read_csv('../data/shotgun_pheno/upenn_all_earlier.csv') 

P2 <- read_csv('../data/shotgun_pheno/upenn_all_later.csv') 

M <- read_csv('../data/shotgun_pheno/msk_all_pheno.csv')
```


```{r}
I1 <- read_csv('../data/shotgun_pheno/italy_all_earlier.csv') %>% 
  filter(timepoint < 0) %>% 
  ungroup() 

# the pheno lable for the I2!
iptb <- readxl::read_excel('/Volumes/castoricenter/CAR-Tcell_and_Microbiota/Italy/patients/italy_essential_data_v4.xlsx', sheet = 1)
I2_pheno <- I2 %>% 
  rename(pt_id = pid) %>% 
  left_join(iptb) 

I_phe <- bind_rows(
  I1 %>% 
    select(fid, pt_id = pid, infusion_date:last_followup), 
  I2_pheno %>% 
    select(fid, pt_id, infusion_date:last_followup)
) %>% 
  mutate(center = 'I')
```

```{r}
# upenn
P_ptb <- readxl::read_excel('/Volumes/castoricenter/CAR-Tcell_and_Microbiota/U Penn/patients/upenn_essential_data_v3.xlsx', sheet = 1)

P_ptb_ineligible <- readxl::read_excel('/Volumes/castoricenter/CAR-Tcell_and_Microbiota/U Penn/patients/upenn_essential_data_v3.xlsx', sheet = 2)

P_ <- bind_rows(
  P %>% 
    mutate(pt_id = str_replace(fid, 'MS_UPENN_','')) %>% select(fid, pt_id) %>% mutate(pt_id = as.numeric(pt_id)),
  P2 %>% 
    mutate(pt_id = as.numeric(fid)) %>% select(fid, pt_id)
) %>% 
  filter(! pt_id %in% P_ptb_ineligible$pt_id)

P_phe <- P_ %>% 
  left_join(P_ptb)  %>% 
  mutate(center = 'P') %>% 
  select(colnames(I_phe))
```


```{r}
# MSK
M_phe <- M %>% 
  mutate(center = 'M',
         pt_id = mrn) %>% 
  select(colnames(I_phe))
```


```{r}
# combined 

all <- bind_rows(
  M_phe %>% mutate(pt_id = as.character(pt_id),
                   icansgrade = as.character(icansgrade)), 
  P_phe %>% 
    mutate(pt_id = as.character(pt_id)), 
  I_phe %>% 
    mutate(icansgrade = as.character(icansgrade))
) %>% 
  mutate(crsgrade = as.character(crsgrade))

# save a copy to the server for John
all %>% 
  write_csv('/Volumes/castoricenter/CAR-Tcell_and_Microbiota/shotgun_results/pheno_data_comprehensive.csv')

# save one for my own
all %>% 
  write_csv('../data/shotgun_pheno/final_comprehensive.csv')
```

## tally of the table

```{r}
# make proper columns factors as they should be 

should_be_factors <- all %>% 
  select_if(is.character) %>% 
  select(-fid, -pt_id) %>% 
  colnames()

ALL <- all %>% 
  mutate_at(should_be_factors, as.factor)



```

```{r}
ALL %>% 
  split(.$center) %>% 
  map_dfr(~ count(x = ., icans), .id = 'center')
```
```{r}
ALL %>% 
  split(.$center) %>% 
  map_dfr(~ count(x = ., crs), .id = 'center')
```

```{r}
outcome <- c('cr_d100','toxicity','icans','crs')

ALL %>% 
  select(outcome) %>% 
  map(function(col){
    ALL %>% 
  split(.$center) %>% 
  map_dfr(~ count(x = ., col), .id = 'center')
  })

for (i in 1:length(outcome)){
  ALL %>% 
    split(.$center) %>% 
    map_dfr(~ count(x = ., outcome[1]), .id = 'center')
}
```

