---
title: "Random Forest to find the top important features"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
library(randomForest)
library(ggpubr)
library(tidyverse)
library(kableExtra)
```

## Response to Toxicity

### Glimpse at pheno table

```{r}
# the species table from metaphlan2
# the species abundance here are actually in percent
s_tb <- read_tsv('../data/metaphlan2_result/merged_abundance_table_species.txt') %>% 
  rename_all(funs(str_replace(., '_profile$','')))

s_tb_sum <- s_tb %>% 
  column_to_rownames('ID') %>% 
  as.matrix() %>% 
  apply(., 2, sum)

# load the pheno
pheno <- read_csv('../data/cleaned_pheno/final_pheno.csv') %>% 
  select(-CAR_Group, -Censor_reason ) %>% 
  mutate_at(vars(str_which(names(.),'Sampleid', negate = T)), factor)

# to rearrange the cts table 
s_tb <- bind_cols(s_tb[,1],s_tb[,pheno$Sampleid]) 

# to put the feature table in the sample as rowname format to do the ML 
s_tb_rf <- s_tb %>% 
  column_to_rownames('ID') %>% 
  as.matrix() %>% 
  t

# check the sample name really match
all.equal(rownames(s_tb_rf), pheno$Sampleid)

# pheno %>% 
#   kable(caption = 'Phenotype info of the final 33 baseline sample patients') %>% 
#   kable_styling(full_width = F)

pheno  %>% 
  summary 
```

### Use only the toxicity as the response variable

```{r}
tox_RF <- randomForest(s_tb_rf, factor(pheno$Toxicity), importance = T)

impor_feature <- importance(tox_RF, type=1) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = 'species') %>% 
  arrange(MeanDecreaseAccuracy)


# plot the err rate change
tox_RF  %>% 
  pluck('err.rate') %>% 
  as.data.frame() %>% 
  mutate(ntree = seq(1, nrow(.))) %>% 
  gather(key = 'type', value = 'ERR', OOB:Y) %>% 
  ggline(x = 'ntree', y = 'ERR', color = 'type', palette = 'lancet') +
  labs(x = 'Number of trees', 
       y = 'Error rate')

tox_RF
```

There are much for Y patients than N. If all assigning to Y it will probably like this.

### Use all of the variables in the pheno table to do RF

```{r} 
# bind the pheno with the transposed cts matrix
combined <- cbind(s_tb_rf, pheno %>% 
                    select(-Sampleid)) 

combined_tox_RF <- randomForest(formula = Toxicity ~ ., data = combined,  importance = T )  

combined_tox_RF  %>% 
  pluck('err.rate') %>% 
  as.data.frame() %>% 
  mutate(ntree = seq(1, nrow(.))) %>% 
  gather(key = 'type', value = 'ERR', OOB:Y) %>% 
  ggline(x = 'ntree', y = 'ERR', color = 'type', palette = 'lancet') +
  labs(x = 'Number of trees', 
       y = 'Error rate')

combined_tox_RF
```


### Removing some not expressive features

```{r}
# check the dist of the species relab sum of the table
s_sum <- s_tb_rf %>% 
  apply(., 2, sum)

data_frame(species = names(s_sum),
           relab_sum = s_sum) %>% 
  gghistogram(x = 'relab_sum', bins = 50)

# remove the species that have less than 1(%) abundance 
length(s_sum[s_sum > 1]) 


combined_fil <- cbind(s_tb_rf[,names(s_sum[s_sum > 1])], pheno %>% 
                    select(-Sampleid)) 


combined_tox_RF_fil <- randomForest(formula = Toxicity ~ ., data = combined_fil,  importance = T )  

combined_tox_RF_fil  %>% 
  pluck('err.rate') %>% 
  as.data.frame() %>% 
  mutate(ntree = seq(1, nrow(.))) %>% 
  gather(key = 'type', value = 'ERR', OOB:Y) %>% 
  ggline(x = 'ntree', y = 'ERR', color = 'type', palette = 'lancet') +
  labs(x = 'Number of trees', 
       y = 'Error rate')

combined_tox_RF_fil 
```

No improvements at all.

### See the important features(species)

```{r}
top_feature <- importance(combined_tox_RF_fil, type=1, scale = F) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = 'species') %>% 
  arrange(desc(MeanDecreaseAccuracy))

top_feature
```


Although Clostridium innocuum are often present and harmless in healthy people, they have been isolated in various infections and predominantly in patients that are immunocompromised as an opportunistic bacteria.





